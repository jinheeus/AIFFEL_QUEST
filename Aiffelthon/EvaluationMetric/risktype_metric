import pandas as pd
import requests
import json
import os
import uuid
from dotenv import load_dotenv
from tqdm import tqdm

# ==============================================================================
# 1. í™˜ê²½ ì„¤ì •
# ==============================================================================
current_dir = os.path.dirname(os.path.abspath(__file__))
root_dir = os.path.dirname(current_dir)
env_path = os.path.join(root_dir, '.env')

if os.path.exists(env_path):
    load_dotenv(dotenv_path=env_path)

CLOVA_API_KEY = os.getenv("CLOVASTUDIO_API_KEY") or os.getenv("NCP_CLOVASTUDIO_API_KEY")
API_URL = os.getenv("NCP_CLOVASTUDIO_URL") or "https://clovastudio.stream.ntruss.com/testapp/v1/chat-completions/HCX-003"

if not CLOVA_API_KEY:
    print("âŒ API Keyê°€ ì—†ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    exit()

# ==============================================================================
# 2. System Prompt (v42 Final: ë‹¨ìœ„ í™˜ì‚° ë©´ì£„ë¶€ ì¶”ê°€)
# ==============================================================================
system_prompt = """
ë‹¹ì‹ ì€ ê³µê³µê¸°ê´€ ê°ì‚¬ ë³´ê³ ì„œì˜ ë°ì´í„° ì •í•©ì„±ì„ ê²€ì¦í•˜ëŠ” ìœ ì—°í•œ AI ê°ì‚¬ê´€ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ [ì›ë¬¸]ì„ ë³´ê³  ì¶”ì¶œëœ [ë°ì´í„°]ì˜ 'ê¸ˆì•¡'ê³¼ 'ë¶„ë¥˜'ê°€ íƒ€ë‹¹í•œì§€ ê²€ì¦í•˜ì„¸ìš”.

[ê²€ì¦ ê¸°ì¤€ - ê´€ëŒ€í•¨ ì ìš©]
1. Amount (ê¸ˆì•¡ ì •í•©ì„±) - Fact Exist Check
   - [ìµœìš°ì„  ì›ì¹™] ì¶”ì¶œëœ ìˆ«ìê°€ ì›ë¬¸ì— ë¬¸ì ê·¸ëŒ€ë¡œ ì¡´ì¬í•œë‹¤ë©´ ë¬´ì¡°ê±´ 'ì •ë‹µ(O)'ì…ë‹ˆë‹¤.
   - ì›ë¬¸ì— ì—†ëŠ” ìˆ«ìë¼ë„, ë¬¸ë§¥ìƒ 'ì´ì•¡ - ë‚´ì—­' ê³„ì‚°ì„ í†µí•´ ë„ì¶œëœ ì”ì•¡ìœ¼ë¡œ ì¶”ì •ë˜ë©´ ì •ë‹µìœ¼ë¡œ ì¸ì •í•˜ì„¸ìš”.

2. Unit Conversion (ë‹¨ìœ„ í™˜ì‚° í•„ë…)
   - [í•µì‹¬] ì›ë¬¸ì— 'ì²œì›', 'ë°±ë§Œì›' ë“±ì˜ ë‹¨ìœ„ê°€ ì“°ì¸ ê²½ìš°, ì¶”ì¶œ ë°ì´í„°ëŠ” ì´ë¥¼ ìˆ«ìë¡œ í™˜ì‚°í•œ ê°’ì…ë‹ˆë‹¤.
   - ì˜ˆ1: ì›ë¬¸ "10ì²œì›" -> ë°ì´í„° "10,000" (ì¼ì¹˜í•¨ / ì •ë‹µ O)
   - ì˜ˆ2: ì›ë¬¸ "15ë°±ë§Œì›" -> ë°ì´í„° "15,000,000" (ì¼ì¹˜í•¨ / ì •ë‹µ O)
   - ìˆ«ì ëª¨ì–‘ì´ ë‹¤ë¥´ë‹¤ê³  í•´ì„œ ì˜¤ë‹µ ì²˜ë¦¬í•˜ì§€ ë§ˆì„¸ìš”. ë‹¨ìœ„ í™˜ì‚°ì´ ë§ìœ¼ë©´ ì •ë‹µì…ë‹ˆë‹¤.

3. Type & Class (ë¶„ë¥˜ ì ì ˆì„±) - ë¬¸ë§¥ ì¡´ì¤‘
   - Money Type: 'í™˜ìˆ˜'ì™€ 'ê°ì•¡'ì€ ë¬¸ë§¥ì— ë”°ë¼ í˜¼ìš©ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì œì¬ì˜ ì„±ê²©ì´ ìˆë‹¤ë©´ ë‘˜ ë‹¤ ì •ë‹µìœ¼ë¡œ í­ë„“ê²Œ ì¸ì •í•˜ì„¸ìš”.
   - Target Class: 'ëŒ€ì™¸(ì—…ì²´)' vs 'ëŒ€ë‚´(ì§ì›)' ë¶„ë¥˜ê°€ ë…¼ë¦¬ì ì´ë©´ ì¸ì •í•˜ì„¸ìš”.

[ì£¼ì˜] 'ì£¼ì²´(Subject)' ëª…ì¹­ì€ ê²€ì¦í•˜ì§€ ë§ˆì„¸ìš” (Skip).

[ë‹µë³€ í˜•ì‹]
ë°˜ë“œì‹œ ì•„ë˜ JSON í¬ë§·ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
{
  "judgment": "O" ë˜ëŠ” "X",
  "reason": "ì˜¤ë‹µì¸ ê²½ìš° êµ¬ì²´ì ì¸ ì´ìœ ",
  "wrong_fields": ["Amount", "Type", "Class"] ì¤‘ í‹€ë¦° í•­ëª© ë¦¬ìŠ¤íŠ¸
}
"""

def call_clova_hcx_comprehensive(user_prompt):
    request_id = str(uuid.uuid4())
    headers = {
        "Authorization": f"Bearer {CLOVA_API_KEY}",
        "X-NCP-CLOVASTUDIO-REQUEST-ID": request_id,
        "Content-Type": "application/json; charset=utf-8",
        "Accept": "text/event-stream"
    }
    
    data = {
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        "topP": 0.6, "topK": 0, "maxTokens": 512, "temperature": 0.1, "repeatPenalty": 5.0, "includeAiFilters": True
    }

    try:
        response = requests.post(API_URL, headers=headers, json=data, stream=True)
        if response.status_code == 200:
            final_content = ""
            is_result_event = False
            for line in response.iter_lines():
                if line:
                    decoded = line.decode('utf-8')
                    if decoded.startswith("event:result"): is_result_event = True
                    if decoded.startswith("data:") and is_result_event:
                        try:
                            js = json.loads(decoded[5:])
                            final_content = js["message"]["content"]
                        except: continue
            return final_content if final_content else "Error: No Content"
        else:
            return f"Error: {response.status_code}"
    except Exception as e:
        return f"Exception: {str(e)}"

# ==============================================================================
# 3. ê²€ì¦ ì‹¤í–‰
# ==============================================================================
excel_filename = 'penalty_v42.xlsx' 
file_path = os.path.join(current_dir, excel_filename)

if not os.path.exists(file_path):
    print(f"âŒ '{excel_filename}' íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. extract_v42.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.")
    exit()

df = pd.read_excel(file_path)
print(f"ğŸ“‚ v42 ë°ì´í„° ë¡œë“œ ì™„ë£Œ: {len(df)}ê±´")

results = []
reasons = []
wrong_fields_list = []

print("ğŸš€ v42 ìµœì¢… ì •ë°€ ê²€ì¦ ì‹œì‘ (HCX - ë‹¨ìœ„ í™˜ì‚° íŒ¨ì¹˜ ì ìš©)...")

# tqdmìœ¼ë¡œ ì§„í–‰ ìƒí™© í‘œì‹œ
for index, row in tqdm(df.iterrows(), total=df.shape[0], ncols=100):
    
    user_prompt = f"""
    [ì›ë¬¸]
    "{row.get('action', '')}"

    [ì¶”ì¶œ ë°ì´í„°]
    1. ê¸ˆì•¡: {row.get('amount', '')} ì›
    2. ìœ í˜•: "{row.get('money_type', '')}"
    3. êµ¬ë¶„: "{row.get('target', '')}"
    (ì°¸ê³ ìš© ì£¼ì²´: "{row.get('target_subject', '')}")
    
    ìœ„ ë°ì´í„°ê°€ [ê²€ì¦ ê¸°ì¤€]ì— ë¶€í•©í•©ë‹ˆê¹Œ?
    """
    
    response = call_clova_hcx_comprehensive(user_prompt)
    
    try:
        clean_res = response.replace("```json", "").replace("```", "").strip()
        parsed = json.loads(clean_res)
        
        results.append(parsed.get("judgment", "Error"))
        reasons.append(parsed.get("reason", response))
        
        w_fields = parsed.get("wrong_fields", [])
        if isinstance(w_fields, list):
            wrong_fields_list.append(", ".join(w_fields))
        else:
            wrong_fields_list.append(str(w_fields))
            
    except:
        results.append("ParseError")
        reasons.append(response)
        wrong_fields_list.append("ParseError")

# ==============================================================================
# 4. ê²°ê³¼ ì €ì¥ ë° ë¦¬í¬íŠ¸
# ==============================================================================
df['hcx_judgment'] = results
df['hcx_reason'] = reasons
df['wrong_fields'] = wrong_fields_list

output_path = os.path.join(current_dir, 'penalty_verified_v42_hcx.xlsx')
df.to_excel(output_path, index=False)

o_cnt = df[df['hcx_judgment'] == 'O'].shape[0]
x_cnt = df[df['hcx_judgment'] == 'X'].shape[0]
total_cnt = o_cnt + x_cnt
accuracy = (o_cnt / total_cnt * 100) if total_cnt > 0 else 0.0

print(f"\nğŸ‰ ê²€ì¦ ì™„ë£Œ! ì €ì¥ë¨: {output_path}")
print("-" * 50)
print(f"ğŸ“Š HCX í†µê³„: ì •ë‹µ(O) {o_cnt}ê±´ ({accuracy:.1f}%) / ì˜¤ë‹µ(X) {x_cnt}ê±´")
print("-" * 50)

if x_cnt > 0:
    print("\nğŸ” ì£¼ìš” ì˜¤ë‹µ í•„ë“œ (Top 5):")
    print(df[df['hcx_judgment'] == 'X']['wrong_fields'].value_counts().head(5))
